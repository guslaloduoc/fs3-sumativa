-- ============================================================
-- MS-RESULTS: Schema de Base de Datos
-- ============================================================
-- Microservicio: ms-results (Puerto 8083)
-- Base de datos: Oracle Cloud ATP
-- Descripcion: Gestión de resultados de análisis clínicos
-- ============================================================

-- Tabla de tipos de análisis de laboratorio
CREATE TABLE tipos_analisis (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre VARCHAR2(100) NOT NULL,
    categoria VARCHAR2(50) NOT NULL,
    unidad_medida VARCHAR2(20),
    valor_referencia_min NUMBER(10, 2),
    valor_referencia_max NUMBER(10, 2),
    activo NUMBER(1) DEFAULT 1 NOT NULL CHECK (activo IN (0, 1))
);

COMMENT ON TABLE tipos_analisis IS 'Catálogo de tipos de análisis clínicos disponibles';
COMMENT ON COLUMN tipos_analisis.id IS 'Identificador único del tipo de análisis';
COMMENT ON COLUMN tipos_analisis.nombre IS 'Nombre del tipo de análisis';
COMMENT ON COLUMN tipos_analisis.categoria IS 'Categoría del análisis (Hematología, Química Sanguínea, etc.)';
COMMENT ON COLUMN tipos_analisis.unidad_medida IS 'Unidad de medida del resultado';
COMMENT ON COLUMN tipos_analisis.valor_referencia_min IS 'Valor mínimo de referencia normal';
COMMENT ON COLUMN tipos_analisis.valor_referencia_max IS 'Valor máximo de referencia normal';
COMMENT ON COLUMN tipos_analisis.activo IS 'Estado del tipo de análisis (1=activo, 0=inactivo)';

-- Índices para mejorar el rendimiento
CREATE INDEX idx_tipos_analisis_nombre ON tipos_analisis(nombre);
CREATE INDEX idx_tipos_analisis_categoria ON tipos_analisis(categoria);
CREATE INDEX idx_tipos_analisis_activo ON tipos_analisis(activo);

-- Tabla de resultados de análisis
CREATE TABLE resultados (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    paciente VARCHAR2(200) NOT NULL,
    fecha_realizacion TIMESTAMP NOT NULL,
    tipo_analisis_id NUMBER NOT NULL,
    laboratorio_id NUMBER NOT NULL,
    valor_numerico NUMBER(10, 2),
    valor_texto VARCHAR2(500),
    estado VARCHAR2(20) DEFAULT 'PENDIENTE' NOT NULL,
    observaciones VARCHAR2(1000),
    creado_en TIMESTAMP NOT NULL,
    actualizado_en TIMESTAMP,
    CONSTRAINT fk_resultados_tipo_analisis FOREIGN KEY (tipo_analisis_id) REFERENCES tipos_analisis(id)
);

COMMENT ON TABLE resultados IS 'Resultados de análisis clínicos de pacientes';
COMMENT ON COLUMN resultados.id IS 'Identificador único del resultado';
COMMENT ON COLUMN resultados.paciente IS 'Nombre del paciente';
COMMENT ON COLUMN resultados.fecha_realizacion IS 'Fecha y hora de realización del análisis';
COMMENT ON COLUMN resultados.tipo_analisis_id IS 'Tipo de análisis realizado';
COMMENT ON COLUMN resultados.laboratorio_id IS 'Laboratorio donde se realizó el análisis';
COMMENT ON COLUMN resultados.valor_numerico IS 'Resultado numérico del análisis';
COMMENT ON COLUMN resultados.valor_texto IS 'Resultado textual (para análisis cualitativos)';
COMMENT ON COLUMN resultados.estado IS 'Estado del resultado (PENDIENTE, COMPLETADO, REVISADO)';
COMMENT ON COLUMN resultados.observaciones IS 'Observaciones adicionales del análisis';
COMMENT ON COLUMN resultados.creado_en IS 'Fecha de creación del registro';
COMMENT ON COLUMN resultados.actualizado_en IS 'Fecha de última actualización';

-- Índices para mejorar el rendimiento
CREATE INDEX idx_resultados_paciente ON resultados(paciente);
CREATE INDEX idx_resultados_laboratorio ON resultados(laboratorio_id);
CREATE INDEX idx_resultados_estado ON resultados(estado);
CREATE INDEX idx_resultados_fecha ON resultados(fecha_realizacion);
