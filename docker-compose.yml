version: '3.8'

services:
  # Frontend Angular
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: labcontrol-frontend
    ports:
      - "4200:80"
    networks:
      - labcontrol-network
    depends_on:
      - ms-users
      - ms-laboratorios
      - ms-results
    restart: unless-stopped
    environment:
      - NODE_ENV=production

  # Microservicio de Usuarios
  ms-users:
    build:
      context: ./ms-users
      dockerfile: Dockerfile
    container_name: labcontrol-ms-users
    ports:
      - "8081:8081"
    networks:
      - labcontrol-network
    environment:
      - SPRING_PROFILES_ACTIVE=oracle
      - DB_TNS_NAME=${DB_TNS_NAME}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - TNS_ADMIN_PATH=/app/wallet
    volumes:
      - ./Wallet_fs3:/app/wallet:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/api/users"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Microservicio de Laboratorios
  ms-laboratorios:
    build:
      context: ./ms-laboratorios
      dockerfile: Dockerfile
    container_name: labcontrol-ms-laboratorios
    ports:
      - "8082:8082"
    networks:
      - labcontrol-network
    environment:
      - SPRING_PROFILES_ACTIVE=oracle
      - DB_TNS_NAME=${DB_TNS_NAME}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - TNS_ADMIN_PATH=/app/wallet
    volumes:
      - ./Wallet_fs3:/app/wallet:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/laboratorios"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Microservicio de Resultados
  ms-results:
    build:
      context: ./ms-results
      dockerfile: Dockerfile
    container_name: labcontrol-ms-results
    ports:
      - "8083:8083"
    networks:
      - labcontrol-network
    environment:
      - SPRING_PROFILES_ACTIVE=oracle
      - DB_TNS_NAME=${DB_TNS_NAME}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - TNS_ADMIN_PATH=/app/wallet
    volumes:
      - ./Wallet_fs3:/app/wallet:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/api/resultados"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  labcontrol-network:
    driver: bridge
    name: labcontrol-network
