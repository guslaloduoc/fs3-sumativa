version: '3.8'

services:
  # API Gateway - Punto de entrada único para todos los microservicios
  ms-gateway:
    build:
      context: ./ms-gateway
      dockerfile: Dockerfile
    container_name: labcontrol-ms-gateway
    ports:
      - "8080:8080"
    networks:
      - labcontrol-network
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      - ms-users
      - ms-laboratorios
      - ms-results
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - JWT_SECRET=${JWT_SECRET:-LabControlSecretKeyForJWTTokenGeneration2025MustBeLongEnoughForHS512Algorithm}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Frontend Angular
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: labcontrol-frontend
    ports:
      - "4101:80"
    networks:
      - labcontrol-network
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      - ms-gateway
    restart: unless-stopped
    environment:
      - NODE_ENV=production

  # Microservicio de Usuarios
  ms-users:
    build:
      context: ./ms-users
      dockerfile: Dockerfile
    container_name: labcontrol-ms-users
    ports:
      - "8081:8081"
    networks:
      - labcontrol-network
    dns:
      - 8.8.8.8
      - 8.8.4.4
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - JWT_SECRET=${JWT_SECRET:-LabControlSecretKeyForJWTTokenGeneration2025MustBeLongEnoughForHS512Algorithm}
      # - DB_TNS_NAME=${DB_TNS_NAME}
      # - DB_USERNAME=${DB_USERNAME}
      # - DB_PASSWORD=${DB_PASSWORD}
      # - TNS_ADMIN_PATH=/app/wallet
    # volumes:
      # - ./Wallet_fs3:/app/wallet:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/api/users"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Microservicio de Laboratorios
  ms-laboratorios:
    build:
      context: ./ms-laboratorios
      dockerfile: Dockerfile
    container_name: labcontrol-ms-laboratorios
    ports:
      - "8082:8082"
    networks:
      - labcontrol-network
    dns:
      - 8.8.8.8
      - 8.8.4.4
    environment:
      - SPRING_PROFILES_ACTIVE=h2
      - JWT_SECRET=${JWT_SECRET:-LabControlSecretKeyForJWTTokenGeneration2025MustBeLongEnoughForHS512Algorithm}
      # - DB_TNS_NAME=${DB_TNS_NAME}
      # - DB_USERNAME=${DB_USERNAME}
      # - DB_PASSWORD=${DB_PASSWORD}
      # - TNS_ADMIN_PATH=/app/wallet
    # volumes:
      # - ./Wallet_fs3:/app/wallet:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/api/laboratorios"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Microservicio de Resultados
  ms-results:
    build:
      context: ./ms-results
      dockerfile: Dockerfile
    container_name: labcontrol-ms-results
    ports:
      - "8083:8083"
    networks:
      - labcontrol-network
    dns:
      - 8.8.8.8
      - 8.8.4.4
    environment:
      - SPRING_PROFILES_ACTIVE=h2
      - JWT_SECRET=${JWT_SECRET:-LabControlSecretKeyForJWTTokenGeneration2025MustBeLongEnoughForHS512Algorithm}
      # - DB_TNS_NAME=${DB_TNS_NAME}
      # - DB_USERNAME=${DB_USERNAME}
      # - DB_PASSWORD=${DB_PASSWORD}
      # - TNS_ADMIN_PATH=/app/wallet
    # volumes:
      # - ./Wallet_fs3:/app/wallet:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/api/resultados"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # SonarQube para análisis de código
  sonarqube:
    image: sonarqube:10-community
    container_name: labcontrol-sonarqube
    ports:
      - "9000:9000"
    networks:
      - labcontrol-network
    environment:
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_logs:/opt/sonarqube/logs
      - sonarqube_extensions:/opt/sonarqube/extensions
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9000/api/system/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

networks:
  labcontrol-network:
    driver: bridge
    name: labcontrol-network

volumes:
  sonarqube_data:
  sonarqube_logs:
  sonarqube_extensions:
